## 线段树
将数组二分，树化，从而实现区间修改和区间求和都是logn的时间复杂度。

线段树的能力覆盖了树状数组，树状数组能完成的，线段树都能完成。

以区间add + 区间求和为例，大致总结下，很多内容注释在了`区间add + 区间求和/SegTreeRangeAddRangeSum.cpp`里。

### 区间查询
从根节点开始，根据当前节点所管辖的范围，递归求解。

当前区间的tree值是结合了懒惰标记的，是最新的。

若当前节点是查询区间的子集时则不需要再递归下去，直接用当前节点的信息返回即可。

若当前节点存在懒惰标记且需要递归子节点时，需要先将懒惰标记下放(pushdown)，将子节点的tree值和lazy值更新为最新(注意更新子节点lazy值时子节点可能已有lazy值)，然后才能递归子节点。

### 区间修改
同样，从根节点开始，根据当前节点所管辖的范围，递归求解。

当前区间的tree值是结合了懒惰标记的，是最新的。

若当前区间是查询区间的子集时则不需要再递归下去，更新当前节点后打好懒惰标记以备后面更新子节点，然后返回即可。

若当前节点存在懒惰标记且需要递归子节点时，需要先将懒惰标记下放(pushdown)，将子节点的tree值和lazy值更新为最新(注意更新子节点lazy值时子节点可能已有lazy值)，然后才能递归子节点，子节点递归完成后，由于子节点进行了修改，所以需要从子节点更新当前节点(pushup)。

### 时间复杂度
详细分析见`区间add + 区间求和/SegTreeRangeAddRangeSum.cpp`里的注释。

树高为O(logn)，节点规模为O(n)

建树: O(n)

区间修改: O(logn)

区间查询: O(logn)

### 线段树性质
关于线段树结构的几个结论，参考<https://blog.csdn.net/lq1990717/article/details/136383448>：

1. 根结点区间长度相差1的两棵线段树的高度相差小于等于1

2. 线段树是平衡二叉树

3. 区间长度为n的线段树的高度为$\lceil \log_2{n} \rceil$

4. 当线段树中某结点左子树高度比右子树高度大1时，右子树是满二叉树

5. 线段树去掉最下面一层的结点后，是满二叉树

以下按单个节点的树高度为0为前提，而非是1

证明1：

归纳证明，记根区间长度为x的线段树的高度为$h(x)$，则要证明对任意x，有$h(x + 1) - h(x) \le 1$

$h(1) = 0, h(2) = 1, h(3) = 2$

假设当$3 < x < k$时，有$h(x + 1) - h(x) \le 1$，对于$x = k$，左右子树的根节点区间长度为$\lceil \frac{k}{2} \rceil$和$\lfloor \frac{k}{2} \rfloor$。树的高度由左子树决定，即$h(k) = h(\lceil \frac{k}{2} \rceil) + 1$。

现在要证有$h(k + 1) - h(k) \le 1$，考虑$h(k + 1)$，其高度为$h(k + 1) = h(\lceil \frac{k + 1}{2} \rceil) + 1$。

$\lceil \frac{k + 1}{2} \rceil$和$\lceil \frac{k}{2} \rceil$相差不超过1(分k为奇偶考虑即可)，$x = k \ge 3$时，$\lceil \frac{k + 1}{2} \rceil$和$\lceil \frac{k}{2} \rceil$都小于k，由归纳假设，$h(\lceil \frac{k + 1}{2} \rceil) - h(\lceil \frac{k}{2} \rceil) \le 1$，于是有$h(k + 1) - h(k) \le 1$。

证明2：

对于根节点区间长度为x的线段树，其左右子树高度为$h(\lceil \frac{x}{2} \rceil)$和$h(\lfloor \frac{x}{2} \rfloor)$。

当x为偶数时，左右子树根节点区间长度相等，左右子树高度相同。

当x为奇数时，左子树区间长度比右子树区间长度大1，由上面的结论，左右子树高度之差不超过1。

于是，任意节点都满足$0 \le 左子树高 - 右子树高 \le 1$，线段树是平衡的。

证明3：

对n进行归纳，$h(1) = 0, h(2) = 1, h(3) = 2$

假设当n < k时，有$h(n) = \lceil \log_2{n} \rceil$，当$n = k$时，$h(k) = h(\lceil \frac{k}{2} \rceil) + 1$，由归纳假设，$h(\lceil \frac{k}{2} \rceil) = \lceil log_2{\lceil \frac{k}{2} \rceil} \rceil$。

当k为偶数时，$h(\lceil \frac{k}{2} \rceil) = \lceil log_2{\lceil \frac{k}{2} \rceil} \rceil = \lceil log_2{\frac{k}{2}} \rceil = \lceil log_2{k} \rceil - 1$，所以$h(k) = h(\lceil \frac{k}{2} \rceil) + 1 = \lceil \log_2{k} \rceil$

当k为奇数时，$h(\lceil \frac{k}{2} \rceil) = \lceil log_2{\lceil \frac{k}{2} \rceil} \rceil = \lceil log_2{\frac{k + 1}{2}} \rceil = \lceil log_2{(k + 1)} \rceil - 1$，由于k是奇数，一定不是2的幂，因此有$\lceil log_2{(k + 1)} \rceil = \lceil log_2{k} \rceil$，所以$h(\lceil \frac{k}{2} \rceil) = \lceil log_2{k} \rceil - 1$，所以$h(k) = h(\lceil \frac{k}{2} \rceil) + 1 = \lceil \log_2{k} \rceil$

于是，$h(n) = \lceil log_2{n} \rceil$

证明4：

左子树高度比右子树高度大1，则此时根节点区间长度k一定为奇数，左子树区间长度为$\frac{k + 1}{2}$，右子树区间长度为$\frac{k - 1}{2}$，高度差为$\lceil log_2{\frac{k + 1}{2}} \rceil - \lceil log_2{\frac{k - 1}{2}} \rceil = \lceil log_2{(k + 1)} \rceil - \lceil log_2{(k - 1)} \rceil = 1$，记$x = \lceil log_2{(k - 1)} \rceil$，则$x + 1 = \lceil log_2{(k + 1)} \rceil$，则$x - 1 < log_2{(k - 1)} \le x < log_2{(k + 1)} \le x + 1$，则$2^{x - 1} < k - 1 \le 2^x < k + 1 \le 2^{x + 1}$，可以推出$2^x - 1 < k \le 2^x + 1$，这段只有2个整数，k又为奇数，于是$k = 2^x + 1$，从而右子树区间长度$\frac{k - 1}{2} = 2^{x - 1}$为2的幂次，区间长度为2的幂次的线段树一定为满二叉树，所以右子树是满二叉树。

证明5：

归纳证明

当根节点区间长度k为1, 2时，满足

假设当n < k时满足，当n = k时，左右子树的根节点区间长度分别为$\lceil \frac{k}{2} \rceil$和$\lfloor \frac{k}{2} \rfloor$。

若左右子树高度不相等，由上面的结论，只能是左子树的高度比右子树高1，且右子树一定为满二叉树，去除最下面的一层节点后，由归纳假设，左子树变成满二叉树，且高度变为与右子树相同，于是整棵树变为满二叉树。

若左右子树高度相等，去除最下面的一层节点，等价于去除左子树和右子树的最下面的一层节点，由归纳假设，去除之后左子树和右子树都变为满二叉树，且高度相同，于是整棵树变为满二叉树。


好像还能有这样一个结论(不是参考链接里的，我自己想的，所以不一定正确)：

* 对于线段树根节点区间长度n，当n1 < n2时，仅考虑树的结构而不考虑元素对应关系，n1所对应的线段树是n2所对应的线段树的子图。

证明：

考虑证明这样一个结论：根节点区间长度为n - 1的线段树是根节点区间长度为n的线段树的子图。

归纳证明，n = 1, 2, 3时结论成立

假设当n < k时结论成立，考虑n = k时，线段树k的左右子树的根区间长度分别为$\lceil \frac{k}{2} \rceil$和$\lfloor \frac{k}{2} \rfloor$，而线段树k - 1的左右子树的根区间长度分别为$\lceil \frac{k - 1}{2} \rceil$和$\lfloor \frac{k - 1}{2} \rfloor$。由归纳假设，线段树$\lceil \frac{k - 1}{2} \rceil$为线段树$\lceil \frac{k}{2} \rceil$的子图，线段树$\lfloor \frac{k - 1}{2} \rfloor$为线段树$\lfloor \frac{k}{2} \rfloor$的子图。

于是，根节点区间长度相差1时，树的结构是有包含关系的，又由于子图的这种包含关系能传递，当n1 < n2时，线段树n2是包含n1的。

注意这里线段树结构的包含是不考虑实际对应的元素的，例如区间长度为2和3对应的线段树分别为：

```
        [0, 1]
        /    \
      [0]    [1]

        [0, 2]
       /     \
     [0, 1]   [2]
    /    \
  [0]    [1]
```
元素之间完全对应不上，但是仅仅考虑结构是子图的关系。